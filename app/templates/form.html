{% extends "base.html" %}
{% block title %}Nueva Evaluación{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- ═══════════════════════════════════════════════
       LEFT: Wizard por bloques
       ═══════════════════════════════════════════════ -->
  <div class="col-lg-8">

    <!-- Header -->
    <div class="mb-3">
      <h4 class="mb-0">
        <i class="bi bi-search-heart-fill text-danger me-2"></i>Evaluación de Evento de Seguridad
      </h4>
      <p class="text-muted small mt-1 mb-0">
        Responde basándote en lo que <em>observas</em>. Usa "No sé" cuando no tengas información.
        No hay respuestas correctas o incorrectas.
      </p>
    </div>

    <!-- Progress bar -->
    <div class="mb-3">
      <div class="d-flex justify-content-between small text-muted mb-1">
        <span id="step-label">Bloque 1 de {{ total_blocks }}</span>
        <span id="step-answered" class="text-muted">0 / {{ total_questions }} respondidas</span>
      </div>
      <div class="progress" style="height: 6px;">
        <div id="progress-bar" class="progress-bar bg-secondary"
             style="width: {{ (1 / total_blocks * 100)|round|int }}%; transition: width 0.3s;"></div>
      </div>
    </div>

    <form id="eval-form" method="post" action="/evaluar">

      <!-- ── Block sections ────────────────────────── -->
      {% for block in blocks %}
      {% set bqs = questions_by_block.get(block.id, []) %}
      <div class="block-section" id="block-{{ loop.index0 }}" style="display:none;">

        <!-- Block header -->
        <div class="block-header d-flex align-items-center gap-3 mb-3 pb-2 border-bottom border-secondary">
          <div class="block-icon-wrap">
            <i class="bi {{ block.icon }} text-danger" style="font-size:1.6rem;"></i>
          </div>
          <div>
            <h5 class="mb-0 fw-bold">{{ block.label }}</h5>
            <small class="text-muted">{{ block.description }}</small>
          </div>
          <span class="ms-auto badge bg-dark border border-secondary text-muted">
            {{ bqs|length }} preguntas
          </span>
        </div>

        <!-- Questions grid: 2 columns × up to 3 rows -->
        <div class="row g-3">
          {% for q in bqs %}
          <div class="col-md-6">
            <div class="question-card h-100" id="qcard-{{ q.id }}">

              <!-- Question text -->
              <div class="qcard-header">
                <span class="q-number">{{ loop.index }}</span>
                <span class="q-text">{{ q.text }}</span>
                {% if q.help %}
                <button type="button"
                        class="btn-help"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        title="{{ q.help }}">
                  <i class="bi bi-question-circle"></i>
                </button>
                {% endif %}
              </div>

              <!-- Help text (mobile-friendly fallback) -->
              {% if q.help %}
              <div class="qcard-help" id="help-{{ q.id }}">
                <i class="bi bi-info-circle me-1 text-muted"></i>{{ q.help }}
              </div>
              {% endif %}

              <!-- Options — neutral, no scores shown, no color coding -->
              <div class="qcard-options">
                {% for opt in weighted_options[q.id] %}
                <div class="q-option">
                  <input type="radio"
                         class="q-radio"
                         name="{{ q.id }}"
                         id="{{ q.id }}_{{ opt.value }}"
                         value="{{ opt.value }}"
                         data-score="{{ opt.weighted_score }}"
                         onchange="onAnswerChange('{{ q.id }}', this)">
                  <label class="q-label" for="{{ q.id }}_{{ opt.value }}">
                    {{ opt.label }}
                  </label>
                </div>
                {% endfor %}
              </div>

            </div>
          </div>
          {% endfor %}
        </div>

      </div><!-- /.block-section -->
      {% endfor %}

      <!-- ── Summary / Analyst step ───────────────── -->
      <div class="block-section" id="block-{{ total_blocks }}" style="display:none;">
        <div class="block-header d-flex align-items-center gap-3 mb-3 pb-2 border-bottom border-secondary">
          <i class="bi bi-send-fill text-danger" style="font-size:1.6rem;"></i>
          <div>
            <h5 class="mb-0 fw-bold">Resumen y Envío</h5>
            <small class="text-muted">Revisión final antes de evaluar el evento.</small>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label small text-muted">Nombre del analista <span class="text-muted">(opcional)</span></label>
            <input type="text"
                   name="analyst_name"
                   class="form-control bg-dark text-light border-secondary"
                   placeholder="Tu nombre o alias...">
          </div>
          <div class="col-12">
            <div id="summary-stats" class="row g-2"></div>
          </div>
          <div class="col-12">
            <div class="alert alert-secondary mb-0">
              <i class="bi bi-info-circle me-2"></i>
              Al enviar, el sistema calculará la clasificación del evento y generará el reporte de análisis.
              Las respuestas no respondidas no contribuyen al puntaje.
            </div>
          </div>
        </div>
      </div>

      <!-- ── Navigation buttons ────────────────────── -->
      <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-outline-secondary" id="btn-prev"
                onclick="prevBlock()" style="display:none;">
          <i class="bi bi-arrow-left me-1"></i> Anterior
        </button>

        <div class="ms-auto d-flex gap-2">
          <button type="button" class="btn btn-primary px-4" id="btn-next"
                  onclick="nextBlock()">
            Siguiente <i class="bi bi-arrow-right ms-1"></i>
          </button>
          <button type="submit" class="btn btn-danger px-5" id="btn-submit"
                  style="display:none;">
            <i class="bi bi-play-fill me-1"></i> Evaluar Evento
          </button>
        </div>
      </div>

    </form><!-- /#eval-form -->
  </div><!-- /.col-lg-8 -->


  <!-- ═══════════════════════════════════════════════
       RIGHT: Sidebar — progreso y estado
       ═══════════════════════════════════════════════ -->
  <div class="col-lg-4">
    <div class="sticky-top" style="top: 80px;">

      <!-- Classification indicator (label only, no number) -->
      <div class="card border-secondary mb-3">
        <div class="card-header text-center py-2">
          <small class="text-muted text-uppercase letter-spacing-1">Nivel de Atención</small>
        </div>
        <div class="card-body text-center py-3">
          <div id="risk-label" class="fw-bold fs-4 mb-1">Informativo</div>
          <div id="risk-desc" class="small text-muted">Continúa respondiendo las preguntas.</div>
          <!-- Subtle level bar — no numbers -->
          <div class="level-bar mt-3">
            <div id="level-fill" class="level-fill" style="width:2%;"></div>
          </div>
          <div class="d-flex justify-content-between" style="font-size:0.65rem; color:#555; margin-top:3px;">
            <span>Bajo</span><span>Medio</span><span>Alto</span><span>Crítico</span>
          </div>
        </div>
      </div>

      <!-- Block checklist -->
      <div class="card border-secondary">
        <div class="card-header py-2">
          <small class="text-muted text-uppercase">Bloques</small>
          <span class="float-end small text-muted" id="answered-count">0 / {{ total_questions }}</span>
        </div>
        <div class="list-group list-group-flush" id="block-checklist">
          {% for block in blocks %}
          <button type="button"
                  class="list-group-item list-group-item-action bg-dark border-secondary d-flex align-items-center gap-2 py-2 checklist-btn"
                  id="chk-{{ loop.index0 }}"
                  onclick="goToBlock({{ loop.index0 }})">
            <i class="bi bi-circle text-secondary small" id="chk-icon-{{ loop.index0 }}"></i>
            <div class="text-start">
              <div class="small fw-semibold" style="font-size:0.8rem;">{{ block.label }}</div>
              <div class="text-muted" style="font-size:0.7rem;">
                {{ questions_by_block.get(block.id, [])|length }} preguntas
              </div>
            </div>
          </button>
          {% endfor %}
          <!-- Summary step -->
          <button type="button"
                  class="list-group-item list-group-item-action bg-dark border-secondary d-flex align-items-center gap-2 py-2 checklist-btn"
                  id="chk-{{ total_blocks }}"
                  onclick="goToBlock({{ total_blocks }})">
            <i class="bi bi-circle text-secondary small" id="chk-icon-{{ total_blocks }}"></i>
            <div class="text-start">
              <div class="small fw-semibold" style="font-size:0.8rem;">Resumen y Envío</div>
            </div>
          </button>
        </div>
      </div>

      <!-- TI Assistant -->
      <div class="card border-secondary mt-3">
        <div class="card-header py-2 d-flex align-items-center">
          <i class="bi bi-shield-lock-fill text-info me-2"></i>
          <small class="text-muted text-uppercase fw-semibold">Asistente TI</small>
          <button class="btn btn-link btn-sm ms-auto p-0 text-muted"
                  data-bs-toggle="collapse" data-bs-target="#ti-assistant-body"
                  style="font-size:0.7rem; text-decoration:none;">▾</button>
        </div>
        <div class="collapse" id="ti-assistant-body">
          <div class="card-body pb-2">

            <!-- IP / Domain lookup -->
            <div class="mb-2">
              <div class="input-group input-group-sm">
                <input type="text" id="form-ti-input"
                       class="form-control bg-dark text-light border-secondary"
                       placeholder="IP o dominio...">
                <select id="form-ti-type"
                        class="form-select form-select-sm bg-dark text-light border-secondary"
                        style="max-width:75px;">
                  <option value="auto">Auto</option>
                  <option value="ip">IP</option>
                  <option value="domain">Dom.</option>
                </select>
                <button class="btn btn-outline-info btn-sm"
                        onclick="TIWidget.lookupTI('form-ti-input','form-ti-type','form-ti-result','form-ti-loading')">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>

            <!-- MAC OUI lookup -->
            <div class="mb-2">
              <div class="input-group input-group-sm">
                <span class="input-group-text bg-dark border-secondary text-muted">
                  <i class="bi bi-hdd-network"></i>
                </span>
                <input type="text" id="form-mac-input"
                       class="form-control bg-dark text-light border-secondary"
                       placeholder="MAC address...">
                <button class="btn btn-outline-secondary btn-sm"
                        onclick="TIWidget.lookupMAC('form-mac-input','form-ti-result')">
                  OUI
                </button>
              </div>
            </div>

            <div id="form-ti-loading" class="text-center py-1 text-muted small" style="display:none;">
              <span class="spinner-border spinner-border-sm me-1"></span>Consultando...
            </div>
            <div id="form-ti-result" style="display:none;"></div>

            <div class="text-muted mt-2" style="font-size:0.65rem;">
              <i class="bi bi-shield-slash me-1"></i>IPs privadas no se consultan externamente.
            </div>
          </div>
        </div>
      </div>

    </div><!-- /.sticky-top -->
  </div><!-- /.col-lg-4 -->

</div><!-- /.row -->
{% endblock %}

{% block scripts %}
<script>
const TOTAL_BLOCKS = {{ total_blocks }};
let currentBlock = 0;
const answeredMap = {}; // q_id -> score

// ── Thresholds (for level indicator — no numbers shown to user)
const LEVELS = [
  { max: 40,  label: "Informativo",      desc: "Evento de bajo riesgo aparente.",         pct: 10, color: "#198754" },
  { max: 110, label: "Sospechoso",        desc: "Algo merece más atención.",               pct: 35, color: "#e0a800" },
  { max: 280, label: "Incidente",         desc: "Requiere investigación activa.",           pct: 60, color: "#fd7e14" },
  { max: 600, label: "Incidente Crítico", desc: "Escalar al equipo de seguridad.",         pct: 82, color: "#dc3545" },
  { max: 9999,"label": "Brecha Confirmada","desc": "Activar protocolo de respuesta.",       pct: 98, color: "#8b0000" },
];

function getLevel(score) {
  for (const l of LEVELS) if (score <= l.max) return l;
  return LEVELS[LEVELS.length - 1];
}

// ── Answer handler
function onAnswerChange(qid, el) {
  answeredMap[qid] = parseFloat(el.dataset.score || 0);
  updateIndicator();
  updateAnsweredCount();
  markCardAnswered(qid);
}

function markCardAnswered(qid) {
  const card = document.getElementById('qcard-' + qid);
  if (card) card.classList.add('answered');
}

function updateIndicator() {
  const total = Object.values(answeredMap).reduce((s, v) => s + v, 0);
  const lvl = getLevel(total);
  document.getElementById('risk-label').textContent = lvl.label;
  document.getElementById('risk-label').style.color = lvl.color;
  document.getElementById('risk-desc').textContent = lvl.desc;
  const fill = document.getElementById('level-fill');
  fill.style.width = lvl.pct + '%';
  fill.style.background = lvl.color;
}

function updateAnsweredCount() {
  const n = Object.keys(answeredMap).length;
  document.getElementById('answered-count').textContent = n + ' / {{ total_questions }}';
  document.getElementById('step-answered').textContent = n + ' / {{ total_questions }} respondidas';
}

// ── Navigation
function goToBlock(index) {
  document.querySelectorAll('.block-section').forEach(el => el.style.display = 'none');
  const target = document.getElementById('block-' + index);
  if (target) { target.style.display = 'block'; target.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
  currentBlock = index;
  updateProgress();
  updateNav();
  updateChecklist();
  if (index === TOTAL_BLOCKS) buildSummaryStats();
}

function nextBlock() { if (currentBlock <= TOTAL_BLOCKS) goToBlock(currentBlock + 1); }
function prevBlock() { if (currentBlock > 0) goToBlock(currentBlock - 1); }

function updateProgress() {
  const pct = Math.round((currentBlock / TOTAL_BLOCKS) * 100);
  document.getElementById('progress-bar').style.width = Math.max(pct, 2) + '%';
  document.getElementById('step-label').textContent =
    currentBlock < TOTAL_BLOCKS
      ? `Bloque ${currentBlock + 1} de ${TOTAL_BLOCKS}`
      : 'Resumen y Envío';
}

function updateNav() {
  document.getElementById('btn-prev').style.display   = currentBlock > 0              ? 'inline-block' : 'none';
  document.getElementById('btn-next').style.display   = currentBlock < TOTAL_BLOCKS   ? 'inline-block' : 'none';
  document.getElementById('btn-submit').style.display = currentBlock === TOTAL_BLOCKS  ? 'inline-block' : 'none';
}

function updateChecklist() {
  for (let i = 0; i <= TOTAL_BLOCKS; i++) {
    const icon = document.getElementById('chk-icon-' + i);
    const btn  = document.getElementById('chk-' + i);
    if (!icon) continue;
    if (i === currentBlock) {
      icon.className = 'bi bi-record-circle-fill text-danger small';
      btn.classList.add('active');
    } else if (i < currentBlock) {
      icon.className = 'bi bi-check-circle-fill text-success small';
      btn.classList.remove('active');
    } else {
      icon.className = 'bi bi-circle text-secondary small';
      btn.classList.remove('active');
    }
  }
}

function buildSummaryStats() {
  const answered = Object.keys(answeredMap).length;
  const total    = {{ total_questions }};
  const missing  = total - answered;
  const html = `
    <div class="col-4">
      <div class="card border-secondary text-center py-2">
        <div class="fs-4 fw-bold">${answered}</div>
        <div class="small text-muted">Respondidas</div>
      </div>
    </div>
    <div class="col-4">
      <div class="card border-secondary text-center py-2">
        <div class="fs-4 fw-bold text-muted">${missing}</div>
        <div class="small text-muted">Sin responder</div>
      </div>
    </div>
    <div class="col-4">
      <div class="card border-secondary text-center py-2">
        <div class="fs-4 fw-bold">${TOTAL_BLOCKS}</div>
        <div class="small text-muted">Bloques</div>
      </div>
    </div>`;
  document.getElementById('summary-stats').innerHTML = html;
}

// ── Init tooltips and first block
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
    new bootstrap.Tooltip(el);
  });
  goToBlock(0);

  // TI assistant — Enter key support
  const tiIn  = document.getElementById('form-ti-input');
  const macIn = document.getElementById('form-mac-input');
  if (tiIn)  tiIn.addEventListener('keydown',  e => { if (e.key === 'Enter') TIWidget.lookupTI('form-ti-input','form-ti-type','form-ti-result','form-ti-loading'); });
  if (macIn) macIn.addEventListener('keydown', e => { if (e.key === 'Enter') TIWidget.lookupMAC('form-mac-input','form-ti-result'); });
});
</script>
{% endblock %}
