{% extends "base.html" %}
{% block title %}Panel de Administración{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-4">
  <h4 class="mb-0"><i class="bi bi-sliders text-danger me-2"></i>Panel de Administración</h4>
  <span class="ms-auto badge bg-warning text-dark">Administrador</span>
</div>

<div class="row g-3">

  <!-- Left column: weights and thresholds -->
  <div class="col-lg-7">

    <!-- Module weights -->
    <div class="card border-secondary mb-3">
      <div class="card-header">
        <i class="bi bi-speedometer me-2"></i>Pesos de Módulos
        <small class="text-muted ms-2">Multiplican el score de todas las preguntas del módulo</small>
      </div>
      <div class="card-body">
        <form method="post" action="/admin/module-weights">
          <div class="row g-3">
            {% for mod in modules %}
            <div class="col-6 col-md-4">
              <label class="form-label small text-muted">{{ mod.label }}</label>
              <input type="number" step="0.1" min="0.1" max="5.0"
                     class="form-control bg-dark text-light border-secondary form-control-sm"
                     name="weight_{{ mod.id }}"
                     value="{{ config.module_weights[mod.id] }}">
            </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary btn-sm mt-3">
            <i class="bi bi-save me-1"></i>Guardar Pesos de Módulos
          </button>
        </form>
      </div>
    </div>

    <!-- Thresholds -->
    <div class="card border-secondary mb-3">
      <div class="card-header">
        <i class="bi bi-sliders2 me-2"></i>Umbrales de Clasificación
      </div>
      <div class="card-body">
        <form method="post" action="/admin/thresholds">
          <div class="table-responsive">
            <table class="table table-dark table-sm">
              <thead><tr><th>Nivel</th><th>Min</th><th>Max</th></tr></thead>
              <tbody>
                {% for key, t in config.thresholds.items() %}
                <tr>
                  <td>
                    <span class="badge badge-cls-{{ key }}">{{ t.emoji }} {{ t.label }}</span>
                  </td>
                  <td>
                    <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary"
                           name="thresh_{{ key }}_min" value="{{ t.min }}" style="width:80px;">
                  </td>
                  <td>
                    <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary"
                           name="thresh_{{ key }}_max" value="{{ t.max }}" style="width:80px;">
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-save me-1"></i>Guardar Umbrales
          </button>
        </form>
      </div>
    </div>

    <!-- Question weights -->
    <div class="card border-secondary mb-3">
      <div class="card-header d-flex align-items-center">
        <i class="bi bi-question-circle me-2"></i>Pesos por Pregunta
        <button class="btn btn-sm btn-outline-secondary ms-auto" type="button"
                data-bs-toggle="collapse" data-bs-target="#questionsTable">
          Expandir / Colapsar
        </button>
      </div>
      <div class="collapse" id="questionsTable">
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 500px; overflow-y:auto;">
            <table class="table table-dark table-sm table-hover mb-0">
              <thead class="sticky-top table-secondary">
                <tr>
                  <th>ID</th>
                  <th>Módulo</th>
                  <th>Pregunta</th>
                  <th>Peso</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for q in questions %}
                <tr>
                  <td class="text-muted small">{{ q.id }}</td>
                  <td><span class="badge bg-secondary small">{{ q.module }}</span></td>
                  <td class="small">{{ q.text[:60] }}...</td>
                  <td>
                    <form method="post" action="/admin/question-weight/{{ q.id }}" class="d-flex gap-1">
                      <input type="number" step="0.1" min="0.1" max="5.0"
                             class="form-control form-control-sm bg-dark text-light border-secondary"
                             name="weight" value="{{ q.weight }}" style="width: 70px;">
                      <button type="submit" class="btn btn-sm btn-outline-primary">OK</button>
                    </form>
                  </td>
                  <td></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Right column: calibration + TI keys -->
  <div class="col-lg-5">

    <!-- ═══ Threat Intelligence API Keys ══════════════════════════════ -->
    {% set ti = ti_display if ti_display is defined else {} %}
    <div class="card border-info mb-3">
      <div class="card-header text-info">
        <i class="bi bi-shield-lock me-2"></i>Fuentes de Inteligencia de Amenazas
        <small class="text-muted ms-2">API Keys — almacenadas localmente en ti_config.json</small>
      </div>
      <div class="card-body">

        {% if request.query_params.get('msg') == 'ti_keys_saved' %}
        <div class="alert alert-success py-2 small"><i class="bi bi-check-circle me-1"></i>Claves guardadas correctamente.</div>
        {% endif %}
        {% if request.query_params.get('msg') == 'ti_keys_cleared' %}
        <div class="alert alert-warning py-2 small"><i class="bi bi-trash me-1"></i>Claves eliminadas.</div>
        {% endif %}

        <form method="post" action="/admin/ti-keys">
          <!-- VirusTotal -->
          <div class="mb-3">
            <label class="form-label small d-flex align-items-center gap-2">
              <span class="fw-semibold text-light">VirusTotal</span>
              {% if ti.virustotal is defined and ti.virustotal.configured %}
              <span class="badge bg-success" style="font-size:0.65rem;">CONFIGURADO</span>
              {% else %}
              <span class="badge bg-secondary" style="font-size:0.65rem;">SIN CLAVE</span>
              {% endif %}
              <a href="https://www.virustotal.com/gui/sign-in" target="_blank"
                 class="ms-auto small text-muted" style="font-size:0.7rem;">Obtener clave</a>
            </label>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-dark border-secondary text-muted">
                <i class="bi bi-key"></i>
              </span>
              <input type="password"
                     name="vt_api_key"
                     class="form-control bg-dark text-light border-secondary"
                     placeholder="{% if ti.virustotal is defined and ti.virustotal.configured %}{{ ti.virustotal.api_key_masked }}{% else %}Pega tu API key aquí...{% endif %}"
                     autocomplete="new-password">
            </div>
            <div class="form-text text-muted" style="font-size:0.7rem;">
              Plan gratuito: 4 req/min, 500 req/día. Soporta IP y dominios.
            </div>
          </div>

          <!-- AbuseIPDB -->
          <div class="mb-3">
            <label class="form-label small d-flex align-items-center gap-2">
              <span class="fw-semibold text-light">AbuseIPDB</span>
              {% if ti.abuseipdb is defined and ti.abuseipdb.configured %}
              <span class="badge bg-success" style="font-size:0.65rem;">CONFIGURADO</span>
              {% else %}
              <span class="badge bg-secondary" style="font-size:0.65rem;">SIN CLAVE</span>
              {% endif %}
              <a href="https://www.abuseipdb.com/register" target="_blank"
                 class="ms-auto small text-muted" style="font-size:0.7rem;">Obtener clave</a>
            </label>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-dark border-secondary text-muted">
                <i class="bi bi-key"></i>
              </span>
              <input type="password"
                     name="abuse_api_key"
                     class="form-control bg-dark text-light border-secondary"
                     placeholder="{% if ti.abuseipdb is defined and ti.abuseipdb.configured %}{{ ti.abuseipdb.api_key_masked }}{% else %}Pega tu API key aquí...{% endif %}"
                     autocomplete="new-password">
            </div>
            <div class="form-text text-muted" style="font-size:0.7rem;">
              Plan gratuito: 1000 req/día. Solo para IPs (no dominios).
            </div>
          </div>

          <!-- IBM X-Force -->
          <div class="mb-3">
            <label class="form-label small d-flex align-items-center gap-2">
              <span class="fw-semibold text-light">IBM X-Force Exchange</span>
              {% if ti.xforce is defined and ti.xforce.configured %}
              <span class="badge bg-success" style="font-size:0.65rem;">CONFIGURADO</span>
              {% else %}
              <span class="badge bg-secondary" style="font-size:0.65rem;">SIN CLAVE</span>
              {% endif %}
              <a href="https://exchange.xforce.ibmcloud.com/login" target="_blank"
                 class="ms-auto small text-muted" style="font-size:0.7rem;">Obtener clave</a>
            </label>
            <div class="input-group input-group-sm mb-1">
              <span class="input-group-text bg-dark border-secondary text-muted" style="width:80px; font-size:0.7rem;">API Key</span>
              <input type="password"
                     name="xforce_api_key"
                     class="form-control bg-dark text-light border-secondary"
                     placeholder="{% if ti.xforce is defined and ti.xforce.configured %}{{ ti.xforce.api_key_masked }}{% else %}API Key...{% endif %}"
                     autocomplete="new-password">
            </div>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-dark border-secondary text-muted" style="width:80px; font-size:0.7rem;">Password</span>
              <input type="password"
                     name="xforce_api_password"
                     class="form-control bg-dark text-light border-secondary"
                     placeholder="{% if ti.xforce is defined and ti.xforce.configured %}{{ ti.xforce.api_password_masked }}{% else %}Password...{% endif %}"
                     autocomplete="new-password">
            </div>
            <div class="form-text text-muted" style="font-size:0.7rem;">
              Requiere API Key + Password separados. Soporta IP y URL.
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-info btn-sm flex-grow-1">
              <i class="bi bi-save me-1"></i>Guardar Claves
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    data-bs-toggle="collapse" data-bs-target="#clear-keys-panel">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </form>

        <div class="collapse mt-2" id="clear-keys-panel">
          <div class="border border-danger rounded p-2">
            <p class="small text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i>
              Eliminar claves guardadas:</p>
            <form method="post" action="/admin/ti-keys/clear" class="d-flex gap-2 align-items-center">
              <select name="source" class="form-select form-select-sm bg-dark text-light border-secondary">
                <option value="all">Todas las fuentes</option>
                <option value="virustotal">Solo VirusTotal</option>
                <option value="abuseipdb">Solo AbuseIPDB</option>
                <option value="xforce">Solo IBM X-Force</option>
              </select>
              <button type="submit" class="btn btn-danger btn-sm">Limpiar</button>
            </form>
          </div>
        </div>

      </div>
    </div>

    <!-- ═══ Webhook Notifications ══════════════════════════════════════ -->
    {% set wh = webhooks if webhooks is defined else {} %}
    <div class="card border-secondary mb-3">
      <div class="card-header">
        <i class="bi bi-bell-fill me-2"></i>Notificaciones Webhook
        <small class="text-muted ms-2">Alerta automática en Crítico / Brecha</small>
      </div>
      <div class="card-body">
        {% if request.query_params.get('msg') == 'webhooks_saved' %}
        <div class="alert alert-success py-2 small"><i class="bi bi-check-circle me-1"></i>Webhooks guardados.</div>
        {% endif %}

        <form method="post" action="/admin/webhooks">
          <!-- Teams -->
          <div class="mb-3">
            <label class="form-label small d-flex align-items-center gap-2">
              <span class="fw-semibold text-light">Microsoft Teams</span>
              {% if wh.teams is defined and wh.teams.enabled %}
              <span class="badge bg-success" style="font-size:0.65rem;">ACTIVO</span>
              {% else %}
              <span class="badge bg-secondary" style="font-size:0.65rem;">INACTIVO</span>
              {% endif %}
              <div class="form-check form-switch ms-auto mb-0">
                <input class="form-check-input" type="checkbox" name="teams_enabled" id="teams-toggle"
                       {% if wh.teams is defined and wh.teams.enabled %}checked{% endif %}>
              </div>
            </label>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-dark border-secondary text-muted">
                <i class="bi bi-link-45deg"></i>
              </span>
              <input type="url" name="teams_url"
                     class="form-control bg-dark text-light border-secondary"
                     placeholder="https://outlook.office.com/webhook/..."
                     value="{% if wh.teams is defined and wh.teams.url %}{{ wh.teams.url }}{% endif %}">
            </div>
            <div class="form-text text-muted" style="font-size:0.7rem;">
              Teams → Canal → Connectores → Webhook entrante
            </div>
          </div>

          <!-- Slack -->
          <div class="mb-3">
            <label class="form-label small d-flex align-items-center gap-2">
              <span class="fw-semibold text-light">Slack</span>
              {% if wh.slack is defined and wh.slack.enabled %}
              <span class="badge bg-success" style="font-size:0.65rem;">ACTIVO</span>
              {% else %}
              <span class="badge bg-secondary" style="font-size:0.65rem;">INACTIVO</span>
              {% endif %}
              <div class="form-check form-switch ms-auto mb-0">
                <input class="form-check-input" type="checkbox" name="slack_enabled" id="slack-toggle"
                       {% if wh.slack is defined and wh.slack.enabled %}checked{% endif %}>
              </div>
            </label>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-dark border-secondary text-muted">
                <i class="bi bi-link-45deg"></i>
              </span>
              <input type="url" name="slack_url"
                     class="form-control bg-dark text-light border-secondary"
                     placeholder="https://hooks.slack.com/services/..."
                     value="{% if wh.slack is defined and wh.slack.url %}{{ wh.slack.url }}{% endif %}">
            </div>
            <div class="form-text text-muted" style="font-size:0.7rem;">
              Slack → App → Incoming Webhooks → Add New
            </div>
          </div>

          <button type="submit" class="btn btn-outline-secondary btn-sm w-100">
            <i class="bi bi-save me-1"></i>Guardar Webhooks
          </button>
        </form>
      </div>
    </div>

    <!-- ═══ TI Lookup Widget ═══════════════════════════════════════════ -->
    <div class="card border-secondary mb-3">
      <div class="card-header">
        <i class="bi bi-search me-2"></i>Consulta Rápida de TI
        <small class="text-muted ms-2">Prueba tus claves con un indicador</small>
      </div>
      <div class="card-body">
        <div class="mb-2">
          <div class="input-group input-group-sm">
            <input type="text" id="ti-indicator-input"
                   class="form-control bg-dark text-light border-secondary"
                   placeholder="8.8.8.8 o malware.com...">
            <select id="ti-type-select" class="form-select form-select-sm bg-dark text-light border-secondary"
                    style="max-width:100px;">
              <option value="auto">Auto</option>
              <option value="ip">IP</option>
              <option value="domain">Dominio</option>
            </select>
            <button class="btn btn-outline-info btn-sm" onclick="runTiLookup()">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>

        <!-- MAC OUI Lookup -->
        <div class="mb-2">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-dark border-secondary text-muted">
              <i class="bi bi-pc-display-horizontal"></i>
            </span>
            <input type="text" id="mac-input"
                   class="form-control bg-dark text-light border-secondary"
                   placeholder="MAC: 00:0C:29:XX:XX:XX">
            <button class="btn btn-outline-secondary btn-sm" onclick="runMacLookup()">
              OUI
            </button>
          </div>
        </div>

        <div id="ti-result" class="mt-2" style="display:none;"></div>
        <div id="ti-loading" class="text-center py-2 text-muted small" style="display:none;">
          <span class="spinner-border spinner-border-sm me-1"></span>Consultando...
        </div>
      </div>
    </div>

    <!-- Calibration -->
    <div class="card border-warning mb-3">
      <div class="card-header text-warning">
        <i class="bi bi-cpu me-2"></i>Calibración Automática
      </div>
      <div class="card-body">
        <p class="small text-muted">
          El sistema analiza los incidentes marcados como resueltos y ajusta automáticamente
          los pesos de las preguntas para reducir falsos positivos y mejorar la precisión.
        </p>
        <p class="small text-muted">
          <strong>Mínimo requerido:</strong> 5 incidentes resueltos.
        </p>
        <form method="post" action="/admin/calibrate">
          <button type="submit" class="btn btn-warning w-100">
            <i class="bi bi-arrow-repeat me-2"></i>Ejecutar Calibración Ahora
          </button>
        </form>
      </div>
    </div>

    <!-- Calibration history -->
    <div class="card border-secondary mb-3">
      <div class="card-header"><i class="bi bi-clock-history me-2"></i>Historial de Calibración</div>
      <div class="card-body p-0">
        {% if cal_logs %}
        <div class="list-group list-group-flush">
          {% for log in cal_logs %}
          <div class="list-group-item bg-dark border-secondary">
            <div class="d-flex justify-content-between">
              <small class="text-muted">{{ log.run_at.strftime('%d/%m/%Y %H:%M') }}</small>
              <span class="badge bg-secondary">{{ log.adjustments_made }} ajustes</span>
            </div>
            <small>
              Incidentes: {{ log.total_incidents }} |
              TP: {{ log.true_positives }} |
              FP: {{ log.false_positives }}
            </small>
            {% if log.notes %}<div class="text-muted" style="font-size:0.7rem;">{{ log.notes }}</div>{% endif %}
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-3 small">Sin registros de calibración aún.</div>
        {% endif %}
      </div>
    </div>

    <!-- Weight adjustment history -->
    <div class="card border-secondary">
      <div class="card-header"><i class="bi bi-journal-text me-2"></i>Últimos Cambios de Pesos</div>
      <div class="card-body p-0">
        {% if weight_history %}
        <div class="list-group list-group-flush" style="max-height:300px; overflow-y:auto;">
          {% for wh in weight_history %}
          <div class="list-group-item bg-dark border-secondary small">
            <div class="d-flex justify-content-between">
              <span>{{ wh.change_type }}</span>
              <span class="text-muted">{{ wh.adjusted_at.strftime('%d/%m %H:%M') }}</span>
            </div>
            {% if wh.question_id %}<span class="text-muted">{{ wh.question_id }}</span>{% endif %}
            {% if wh.module %}<span class="badge bg-dark border-secondary">{{ wh.module }}</span>{% endif %}
            <span class="text-warning">{{ wh.old_value }}</span> →
            <span class="text-success">{{ wh.new_value }}</span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-3 small">Sin cambios registrados aún.</div>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Admin TI widget — delegates to shared TIWidget in main.js
document.addEventListener('DOMContentLoaded', () => {
  const tiInput  = document.getElementById('ti-indicator-input');
  const macInput = document.getElementById('mac-input');
  if (tiInput)  tiInput.addEventListener('keydown',  e => { if (e.key === 'Enter') TIWidget.lookupTI('ti-indicator-input','ti-type-select','ti-result','ti-loading'); });
  if (macInput) macInput.addEventListener('keydown', e => { if (e.key === 'Enter') TIWidget.lookupMAC('mac-input','ti-result'); });
});
function runTiLookup()  { TIWidget.lookupTI('ti-indicator-input','ti-type-select','ti-result','ti-loading'); }
function runMacLookup() { TIWidget.lookupMAC('mac-input','ti-result'); }
</script>
{% endblock %}
