{% extends "base.html" %}
{% block title %}Panel de Administración{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-4">
  <h4 class="mb-0"><i class="bi bi-sliders text-danger me-2"></i>Panel de Administración</h4>
  <span class="ms-auto badge bg-warning text-dark">Administrador</span>
</div>

<div class="row g-3">

  <!-- Left column: weights and thresholds -->
  <div class="col-lg-7">

    <!-- Module weights -->
    <div class="card border-secondary mb-3">
      <div class="card-header">
        <i class="bi bi-speedometer me-2"></i>Pesos de Módulos
        <small class="text-muted ms-2">Multiplican el score de todas las preguntas del módulo</small>
      </div>
      <div class="card-body">
        <form method="post" action="/admin/module-weights">
          <div class="row g-3">
            {% for mod in modules %}
            <div class="col-6 col-md-4">
              <label class="form-label small text-muted">{{ mod.label }}</label>
              <input type="number" step="0.1" min="0.1" max="5.0"
                     class="form-control bg-dark text-light border-secondary form-control-sm"
                     name="weight_{{ mod.id }}"
                     value="{{ config.module_weights[mod.id] }}">
            </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary btn-sm mt-3">
            <i class="bi bi-save me-1"></i>Guardar Pesos de Módulos
          </button>
        </form>
      </div>
    </div>

    <!-- Thresholds -->
    <div class="card border-secondary mb-3">
      <div class="card-header">
        <i class="bi bi-sliders2 me-2"></i>Umbrales de Clasificación
      </div>
      <div class="card-body">
        <form method="post" action="/admin/thresholds">
          <div class="table-responsive">
            <table class="table table-dark table-sm">
              <thead><tr><th>Nivel</th><th>Min</th><th>Max</th></tr></thead>
              <tbody>
                {% for key, t in config.thresholds.items() %}
                <tr>
                  <td>
                    <span class="badge badge-cls-{{ key }}">{{ t.emoji }} {{ t.label }}</span>
                  </td>
                  <td>
                    <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary"
                           name="thresh_{{ key }}_min" value="{{ t.min }}" style="width:80px;">
                  </td>
                  <td>
                    <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary"
                           name="thresh_{{ key }}_max" value="{{ t.max }}" style="width:80px;">
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-save me-1"></i>Guardar Umbrales
          </button>
        </form>
      </div>
    </div>

    <!-- Question weights -->
    <div class="card border-secondary mb-3">
      <div class="card-header d-flex align-items-center">
        <i class="bi bi-question-circle me-2"></i>Pesos por Pregunta
        <button class="btn btn-sm btn-outline-secondary ms-auto" type="button"
                data-bs-toggle="collapse" data-bs-target="#questionsTable">
          Expandir / Colapsar
        </button>
      </div>
      <div class="collapse" id="questionsTable">
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 500px; overflow-y:auto;">
            <table class="table table-dark table-sm table-hover mb-0">
              <thead class="sticky-top table-secondary">
                <tr>
                  <th>ID</th>
                  <th>Módulo</th>
                  <th>Pregunta</th>
                  <th>Peso</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for q in questions %}
                <tr>
                  <td class="text-muted small">{{ q.id }}</td>
                  <td><span class="badge bg-secondary small">{{ q.module }}</span></td>
                  <td class="small">{{ q.text[:60] }}...</td>
                  <td>
                    <form method="post" action="/admin/question-weight/{{ q.id }}" class="d-flex gap-1">
                      <input type="number" step="0.1" min="0.1" max="5.0"
                             class="form-control form-control-sm bg-dark text-light border-secondary"
                             name="weight" value="{{ q.weight }}" style="width: 70px;">
                      <button type="submit" class="btn btn-sm btn-outline-primary">OK</button>
                    </form>
                  </td>
                  <td></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Right column: calibration + TI keys -->
  <div class="col-lg-5">

    <!-- ═══ Threat Intelligence API Keys ══════════════════════════════ -->
    <div class="card border-info mb-3">
      <div class="card-header text-info">
        <i class="bi bi-shield-lock me-2"></i>Fuentes de Inteligencia de Amenazas
        <small class="text-muted ms-2">API Keys — almacenadas localmente en ti_config.json</small>
      </div>
      <div class="card-body">

        {% if request.query_params.get('msg') == 'ti_keys_saved' %}
        <div class="alert alert-success py-2 small"><i class="bi bi-check-circle me-1"></i>Claves guardadas correctamente.</div>
        {% endif %}
        {% if request.query_params.get('msg') == 'ti_keys_cleared' %}
        <div class="alert alert-warning py-2 small"><i class="bi bi-trash me-1"></i>Claves eliminadas.</div>
        {% endif %}

        <form method="post" action="/admin/ti-keys">
          <!-- VirusTotal -->
          <div class="mb-3">
            <label class="form-label small d-flex align-items-center gap-2">
              <span class="fw-semibold text-light">VirusTotal</span>
              {% if ti_display.virustotal.configured %}
              <span class="badge bg-success" style="font-size:0.65rem;">CONFIGURADO</span>
              {% else %}
              <span class="badge bg-secondary" style="font-size:0.65rem;">SIN CLAVE</span>
              {% endif %}
              <a href="https://www.virustotal.com/gui/sign-in" target="_blank"
                 class="ms-auto small text-muted" style="font-size:0.7rem;">Obtener clave</a>
            </label>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-dark border-secondary text-muted">
                <i class="bi bi-key"></i>
              </span>
              <input type="password"
                     name="vt_api_key"
                     class="form-control bg-dark text-light border-secondary"
                     placeholder="{% if ti_display.virustotal.configured %}{{ ti_display.virustotal.api_key_masked }}{% else %}Pega tu API key aquí...{% endif %}"
                     autocomplete="new-password">
            </div>
            <div class="form-text text-muted" style="font-size:0.7rem;">
              Plan gratuito: 4 req/min, 500 req/día. Soporta IP y dominios.
            </div>
          </div>

          <!-- AbuseIPDB -->
          <div class="mb-3">
            <label class="form-label small d-flex align-items-center gap-2">
              <span class="fw-semibold text-light">AbuseIPDB</span>
              {% if ti_display.abuseipdb.configured %}
              <span class="badge bg-success" style="font-size:0.65rem;">CONFIGURADO</span>
              {% else %}
              <span class="badge bg-secondary" style="font-size:0.65rem;">SIN CLAVE</span>
              {% endif %}
              <a href="https://www.abuseipdb.com/register" target="_blank"
                 class="ms-auto small text-muted" style="font-size:0.7rem;">Obtener clave</a>
            </label>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-dark border-secondary text-muted">
                <i class="bi bi-key"></i>
              </span>
              <input type="password"
                     name="abuse_api_key"
                     class="form-control bg-dark text-light border-secondary"
                     placeholder="{% if ti_display.abuseipdb.configured %}{{ ti_display.abuseipdb.api_key_masked }}{% else %}Pega tu API key aquí...{% endif %}"
                     autocomplete="new-password">
            </div>
            <div class="form-text text-muted" style="font-size:0.7rem;">
              Plan gratuito: 1000 req/día. Solo para IPs (no dominios).
            </div>
          </div>

          <!-- IBM X-Force -->
          <div class="mb-3">
            <label class="form-label small d-flex align-items-center gap-2">
              <span class="fw-semibold text-light">IBM X-Force Exchange</span>
              {% if ti_display.xforce.configured %}
              <span class="badge bg-success" style="font-size:0.65rem;">CONFIGURADO</span>
              {% else %}
              <span class="badge bg-secondary" style="font-size:0.65rem;">SIN CLAVE</span>
              {% endif %}
              <a href="https://exchange.xforce.ibmcloud.com/login" target="_blank"
                 class="ms-auto small text-muted" style="font-size:0.7rem;">Obtener clave</a>
            </label>
            <div class="input-group input-group-sm mb-1">
              <span class="input-group-text bg-dark border-secondary text-muted" style="width:80px; font-size:0.7rem;">API Key</span>
              <input type="password"
                     name="xforce_api_key"
                     class="form-control bg-dark text-light border-secondary"
                     placeholder="{% if ti_display.xforce.configured %}{{ ti_display.xforce.api_key_masked }}{% else %}API Key...{% endif %}"
                     autocomplete="new-password">
            </div>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-dark border-secondary text-muted" style="width:80px; font-size:0.7rem;">Password</span>
              <input type="password"
                     name="xforce_api_password"
                     class="form-control bg-dark text-light border-secondary"
                     placeholder="{% if ti_display.xforce.configured %}{{ ti_display.xforce.api_password_masked }}{% else %}Password...{% endif %}"
                     autocomplete="new-password">
            </div>
            <div class="form-text text-muted" style="font-size:0.7rem;">
              Requiere API Key + Password separados. Soporta IP y URL.
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-info btn-sm flex-grow-1">
              <i class="bi bi-save me-1"></i>Guardar Claves
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    data-bs-toggle="collapse" data-bs-target="#clear-keys-panel">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </form>

        <div class="collapse mt-2" id="clear-keys-panel">
          <div class="border border-danger rounded p-2">
            <p class="small text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i>
              Eliminar claves guardadas:</p>
            <form method="post" action="/admin/ti-keys/clear" class="d-flex gap-2 align-items-center">
              <select name="source" class="form-select form-select-sm bg-dark text-light border-secondary">
                <option value="all">Todas las fuentes</option>
                <option value="virustotal">Solo VirusTotal</option>
                <option value="abuseipdb">Solo AbuseIPDB</option>
                <option value="xforce">Solo IBM X-Force</option>
              </select>
              <button type="submit" class="btn btn-danger btn-sm">Limpiar</button>
            </form>
          </div>
        </div>

      </div>
    </div>

    <!-- ═══ TI Lookup Widget ═══════════════════════════════════════════ -->
    <div class="card border-secondary mb-3">
      <div class="card-header">
        <i class="bi bi-search me-2"></i>Consulta Rápida de TI
        <small class="text-muted ms-2">Prueba tus claves con un indicador</small>
      </div>
      <div class="card-body">
        <div class="mb-2">
          <div class="input-group input-group-sm">
            <input type="text" id="ti-indicator-input"
                   class="form-control bg-dark text-light border-secondary"
                   placeholder="8.8.8.8 o malware.com...">
            <select id="ti-type-select" class="form-select form-select-sm bg-dark text-light border-secondary"
                    style="max-width:100px;">
              <option value="auto">Auto</option>
              <option value="ip">IP</option>
              <option value="domain">Dominio</option>
            </select>
            <button class="btn btn-outline-info btn-sm" onclick="runTiLookup()">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>

        <!-- MAC OUI Lookup -->
        <div class="mb-2">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-dark border-secondary text-muted">
              <i class="bi bi-pc-display-horizontal"></i>
            </span>
            <input type="text" id="mac-input"
                   class="form-control bg-dark text-light border-secondary"
                   placeholder="MAC: 00:0C:29:XX:XX:XX">
            <button class="btn btn-outline-secondary btn-sm" onclick="runMacLookup()">
              OUI
            </button>
          </div>
        </div>

        <div id="ti-result" class="mt-2" style="display:none;"></div>
        <div id="ti-loading" class="text-center py-2 text-muted small" style="display:none;">
          <span class="spinner-border spinner-border-sm me-1"></span>Consultando...
        </div>
      </div>
    </div>

    <!-- Calibration -->
    <div class="card border-warning mb-3">
      <div class="card-header text-warning">
        <i class="bi bi-cpu me-2"></i>Calibración Automática
      </div>
      <div class="card-body">
        <p class="small text-muted">
          El sistema analiza los incidentes marcados como resueltos y ajusta automáticamente
          los pesos de las preguntas para reducir falsos positivos y mejorar la precisión.
        </p>
        <p class="small text-muted">
          <strong>Mínimo requerido:</strong> 5 incidentes resueltos.
        </p>
        <form method="post" action="/admin/calibrate">
          <button type="submit" class="btn btn-warning w-100">
            <i class="bi bi-arrow-repeat me-2"></i>Ejecutar Calibración Ahora
          </button>
        </form>
      </div>
    </div>

    <!-- Calibration history -->
    <div class="card border-secondary mb-3">
      <div class="card-header"><i class="bi bi-clock-history me-2"></i>Historial de Calibración</div>
      <div class="card-body p-0">
        {% if cal_logs %}
        <div class="list-group list-group-flush">
          {% for log in cal_logs %}
          <div class="list-group-item bg-dark border-secondary">
            <div class="d-flex justify-content-between">
              <small class="text-muted">{{ log.run_at.strftime('%d/%m/%Y %H:%M') }}</small>
              <span class="badge bg-secondary">{{ log.adjustments_made }} ajustes</span>
            </div>
            <small>
              Incidentes: {{ log.total_incidents }} |
              TP: {{ log.true_positives }} |
              FP: {{ log.false_positives }}
            </small>
            {% if log.notes %}<div class="text-muted" style="font-size:0.7rem;">{{ log.notes }}</div>{% endif %}
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-3 small">Sin registros de calibración aún.</div>
        {% endif %}
      </div>
    </div>

    <!-- Weight adjustment history -->
    <div class="card border-secondary">
      <div class="card-header"><i class="bi bi-journal-text me-2"></i>Últimos Cambios de Pesos</div>
      <div class="card-body p-0">
        {% if weight_history %}
        <div class="list-group list-group-flush" style="max-height:300px; overflow-y:auto;">
          {% for wh in weight_history %}
          <div class="list-group-item bg-dark border-secondary small">
            <div class="d-flex justify-content-between">
              <span>{{ wh.change_type }}</span>
              <span class="text-muted">{{ wh.adjusted_at.strftime('%d/%m %H:%M') }}</span>
            </div>
            {% if wh.question_id %}<span class="text-muted">{{ wh.question_id }}</span>{% endif %}
            {% if wh.module %}<span class="badge bg-dark border-secondary">{{ wh.module }}</span>{% endif %}
            <span class="text-warning">{{ wh.old_value }}</span> →
            <span class="text-success">{{ wh.new_value }}</span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-3 small">Sin cambios registrados aún.</div>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ── TI Lookup Widget ────────────────────────────────────────────────────────
async function runTiLookup() {
  const indicator = document.getElementById('ti-indicator-input').value.trim();
  const type = document.getElementById('ti-type-select').value;
  const resultEl = document.getElementById('ti-result');
  const loadingEl = document.getElementById('ti-loading');
  if (!indicator) return;

  resultEl.style.display = 'none';
  loadingEl.style.display = 'block';

  try {
    const resp = await fetch('/api/ti/lookup', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({indicator, type, sources: ['virustotal','abuseipdb','xforce']})
    });
    const data = await resp.json();
    resultEl.innerHTML = renderTiResult(data);
  } catch (e) {
    resultEl.innerHTML = `<div class="alert alert-danger py-2 small">Error: ${e.message}</div>`;
  } finally {
    loadingEl.style.display = 'none';
    resultEl.style.display = 'block';
  }
}

async function runMacLookup() {
  const mac = document.getElementById('mac-input').value.trim();
  const resultEl = document.getElementById('ti-result');
  if (!mac) return;

  try {
    const resp = await fetch(`/api/mac/lookup?mac=${encodeURIComponent(mac)}`);
    const data = await resp.json();
    resultEl.innerHTML = renderMacResult(data);
    resultEl.style.display = 'block';
  } catch (e) {
    resultEl.innerHTML = `<div class="alert alert-danger py-2 small">Error: ${e.message}</div>`;
    resultEl.style.display = 'block';
  }
}

function verdictBadge(v) {
  const map = {
    'MALICIOSO':     'bg-danger',
    'SOSPECHOSO':    'bg-warning text-dark',
    'LIMPIO':        'bg-success',
    'BLOQUEADO':     'bg-secondary',
    'SIN_RESULTADOS':'bg-secondary',
    'ERROR':         'bg-danger',
  };
  return `<span class="badge ${map[v] || 'bg-secondary'}">${v}</span>`;
}

function renderTiResult(data) {
  if (data.blocked) {
    return `<div class="alert alert-secondary py-2 small">
      <i class="bi bi-shield-slash me-1"></i><strong>IP Bloqueada:</strong> ${data.block_reason}
    </div>`;
  }

  let html = `<div class="mb-2 d-flex align-items-center gap-2">
    <strong class="small">${data.indicator}</strong>
    ${verdictBadge(data.summary_verdict)}
  </div>`;

  for (const r of (data.results || [])) {
    html += `<div class="border border-secondary rounded p-2 mb-1" style="font-size:0.75rem;">
      <div class="d-flex justify-content-between">
        <strong>${r.source}</strong>${verdictBadge(r.verdict)}
      </div>`;
    if (r.source === 'VirusTotal') {
      html += `<div>Detecciones: <span class="text-danger">${r.malicious_votes}</span>/${r.total_engines} motores</div>`;
      if (r.country) html += `<div class="text-muted">País: ${r.country} | AS: ${r.as_owner || 'N/A'}</div>`;
    } else if (r.source === 'AbuseIPDB') {
      html += `<div>Score abuso: <span class="text-warning">${r.abuse_score}%</span> (${r.total_reports} reportes)</div>`;
      html += `<div class="text-muted">País: ${r.country} | ISP: ${r.isp}</div>`;
      if (r.is_tor) html += `<span class="badge bg-danger">TOR EXIT NODE</span>`;
    } else if (r.source === 'IBM X-Force') {
      html += `<div>Risk Score: <span class="text-warning">${r.risk_score}/10</span></div>`;
      if (r.categories && r.categories.length > 0) html += `<div class="text-muted">${r.categories.join(', ')}</div>`;
    }
    if (r.raw_url) html += `<a href="${r.raw_url}" target="_blank" class="small text-info">Ver en fuente</a>`;
    html += `</div>`;
  }

  for (const e of (data.errors || [])) {
    html += `<div class="alert alert-secondary py-1 small mb-1">
      <strong>${e.source}:</strong> ${e.error}
    </div>`;
  }

  return html;
}

function renderMacResult(data) {
  if (data.error) {
    return `<div class="alert alert-warning py-2 small">${data.error}</div>`;
  }
  const found = data.found;
  return `<div class="border border-secondary rounded p-2" style="font-size:0.8rem;">
    <div class="d-flex align-items-center gap-2 mb-1">
      <i class="bi ${data.icon || 'bi-question-circle'} text-info"></i>
      <strong>${data.vendor}</strong>
      <span class="badge bg-dark border border-secondary">${data.category}</span>
      ${found ? '<span class="badge bg-success">Encontrado</span>' : '<span class="badge bg-secondary">No encontrado</span>'}
    </div>
    <div class="text-muted">OUI: <code>${data.oui}</code> | MAC: <code>${data.mac_normalized}</code></div>
  </div>`;
}

// Enter key support
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('ti-indicator-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') runTiLookup();
  });
  document.getElementById('mac-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') runMacLookup();
  });
});
</script>
{% endblock %}
