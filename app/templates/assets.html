{% extends "base.html" %}
{% block title %}Inventario de Activos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-0"><i class="bi bi-cpu-fill text-warning me-2"></i>Inventario de Activos</h2>
    <small class="text-muted">{{ total }} activo{{ 's' if total != 1 }} encontrado{{ 's' if total != 1 }}</small>
  </div>
  <div class="d-flex gap-2">
    <a href="/activos/exportar/template" class="btn btn-sm btn-outline-secondary" title="Descargar template CSV">
      <i class="bi bi-file-earmark-arrow-down me-1"></i>Template CSV
    </a>
    <a href="/activos/exportar/csv" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-download me-1"></i>Exportar CSV
    </a>
    <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalImport">
      <i class="bi bi-upload me-1"></i>Importar CSV
    </button>
    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalNuevoActivo">
      <i class="bi bi-plus-circle me-1"></i>Nuevo Activo
    </button>
  </div>
</div>

<!-- Alert banners: review notifications -->
{% if overdue_count > 0 %}
<div class="alert alert-danger d-flex align-items-center gap-3 mb-3">
  <i class="bi bi-exclamation-triangle-fill fs-4"></i>
  <div class="flex-grow-1">
    <strong>{{ overdue_count }} activo{{ 's' if overdue_count != 1 }} con revisión VENCIDA</strong>
    <div class="small">Estos activos superaron su fecha de revisión y requieren atención inmediata.</div>
  </div>
  <a href="/activos?review_due=1" class="btn btn-sm btn-outline-danger">Ver activos</a>
</div>
{% endif %}
{% if upcoming_count > 0 %}
<div class="alert alert-warning d-flex align-items-center gap-3 mb-3">
  <i class="bi bi-clock-history fs-4"></i>
  <div class="flex-grow-1">
    <strong>{{ upcoming_count }} activo{{ 's' if upcoming_count != 1 }} próximo{{ 's' if upcoming_count != 1 }} a revisar</strong>
    <div class="small">Revisión pendiente en los próximos 30 días.</div>
  </div>
  <a href="/activos?review_due=1" class="btn btn-sm btn-outline-warning">Ver activos</a>
</div>
{% endif %}

<!-- Flash msg -->
{% if msg %}
<div class="alert alert-{{ 'success' if 'created' in msg or 'imported' in msg or 'updated' in msg else 'info' }} alert-dismissible fade show mb-3">
  {% if msg == 'created' %}Activo creado correctamente.
  {% elif msg == 'updated' %}Activo actualizado.
  {% elif msg == 'fields_required' %}Nombre e identificador son obligatorios.
  {% elif msg == 'invalid_file' %}Archivo no válido. Debe ser .csv
  {% elif 'imported_' in msg %}{{ msg.split('_')[1] }} activo(s) importado(s) correctamente.
  {% else %}Operación completada.{% endif %}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Filters -->
<div class="card border-secondary mb-3">
  <div class="card-body py-2">
    <form method="get" action="/activos" class="row g-2 align-items-end">
      <div class="col-md-4">
        <input type="text" name="q" class="form-control form-control-sm bg-dark text-light border-secondary"
               placeholder="Buscar nombre, IP, hostname..." value="{{ filters.q }}">
      </div>
      <div class="col-md-2">
        <select name="type" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">Todos los tipos</option>
          {% for val, label in asset_types %}
          <option value="{{ val }}" {{ 'selected' if filters.type == val }}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select name="criticality" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">Toda criticidad</option>
          {% for lvl in range(5, 0, -1) %}
          {% set cl = criticality_labels[lvl] %}
          <option value="{{ lvl }}" {{ 'selected' if filters.criticality == lvl|string }}>
            {{ lvl }} — {{ cl[0] }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 d-flex gap-2">
        <div class="form-check form-check-inline mt-1">
          <input class="form-check-input" type="checkbox" name="review_due" value="1" id="chkReview"
                 {{ 'checked' if filters.review_due }}>
          <label class="form-check-label small" for="chkReview">Revisión pendiente</label>
        </div>
      </div>
      <div class="col-md-2 d-flex gap-2">
        <button type="submit" class="btn btn-sm btn-outline-info w-100">
          <i class="bi bi-search me-1"></i>Filtrar
        </button>
        <a href="/activos" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-x-circle"></i>
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Assets table -->
{% if assets %}
<div class="card border-secondary">
  <div class="table-responsive">
    <table class="table table-dark table-hover table-sm mb-0">
      <thead class="border-secondary text-muted small">
        <tr>
          <th>Activo</th>
          <th>Tipo</th>
          <th>Identificador</th>
          <th class="text-center">Criticidad</th>
          <th class="text-center">Multiplicador</th>
          <th>Responsable</th>
          <th>Próxima Revisión</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for a in assets %}
        {% set cl = criticality_labels.get(a.criticality, ('Medio','info')) %}
        {% set mult = criticality_multipliers.get(a.criticality, 1.0) %}
        {% set now_ts = now if now is defined else none %}
        {% set is_overdue = a.next_review_at and a.next_review_at < now_ts if now_ts else false %}
        <tr class="{{ 'table-danger' if not a.is_active else '' }}">
          <td>
            <a href="/activos/{{ a.id }}" class="text-decoration-none text-light fw-semibold">
              {{ a.name }}
            </a>
            {% if not a.is_active %}
            <span class="badge bg-secondary ms-1" style="font-size:0.6rem;">Inactivo</span>
            {% endif %}
          </td>
          <td>
            <span class="text-muted small">
              {% set type_icons2 = {
                'ip': 'bi-ethernet',
                'hostname': 'bi-pc-display',
                'server': 'bi-server',
                'service': 'bi-gear',
                'network_segment': 'bi-diagram-2',
                'user_account': 'bi-person',
                'critical_user': 'bi-person-fill-exclamation',
                'other': 'bi-box',
              } %}
              <i class="bi {{ type_icons2.get(a.asset_type, 'bi-box') }} me-1"></i>
              {{ dict(asset_types).get(a.asset_type, a.asset_type) }}
            </span>
          </td>
          <td class="font-monospace small text-muted">{{ a.identifier }}</td>
          <td class="text-center">
            <span class="badge bg-{{ cl[1] }} {{ 'text-dark' if cl[1] in ('warning','light','info') else '' }}">
              {{ cl[0] }}
            </span>
          </td>
          <td class="text-center">
            <span class="badge {{ 'bg-danger' if mult > 1 else 'bg-success' if mult < 1 else 'bg-secondary' }}">
              ×{{ "%.1f"|format(mult) }}
            </span>
          </td>
          <td>
            {% set resp = a.contacts | selectattr('contact_type', 'eq', 'responsible') | first %}
            {% if resp %}
            <span class="small">{{ resp.name }}</span>
            {% if resp.email %}<div class="text-muted" style="font-size:0.7rem;">{{ resp.email }}</div>{% endif %}
            {% else %}
            <span class="text-muted small">—</span>
            {% endif %}
          </td>
          <td>
            {% if a.next_review_at %}
            <span class="small {{ 'text-danger fw-bold' if is_overdue else 'text-warning' if mult > 0 else '' }}">
              <i class="bi bi-{{ 'exclamation-triangle-fill text-danger' if is_overdue else 'calendar-check' }} me-1"></i>
              {{ a.next_review_at.strftime('%Y-%m-%d') }}
            </span>
            {% else %}
            <span class="text-muted small">—</span>
            {% endif %}
          </td>
          <td class="text-end">
            <a href="/activos/{{ a.id }}" class="btn btn-sm btn-outline-info py-0 px-2">
              <i class="bi bi-eye"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="text-center py-5 text-muted">
  <i class="bi bi-cpu fs-1 d-block mb-3"></i>
  <p>No hay activos cargados. Agregá el primer activo con el botón <strong>Nuevo Activo</strong>
  o importá desde un CSV.</p>
  <a href="/activos/exportar/template" class="btn btn-outline-secondary">
    <i class="bi bi-file-earmark-arrow-down me-1"></i>Descargar Template CSV
  </a>
</div>
{% endif %}

<!-- Modal: Nuevo Activo -->
<div class="modal fade" id="modalNuevoActivo" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form method="post" action="/activos/nuevo" class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="bi bi-plus-circle text-warning me-2"></i>Nuevo Activo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <!-- Datos principales -->
          <div class="col-md-6">
            <label class="form-label small">Nombre del Activo <span class="text-danger">*</span></label>
            <input type="text" name="name" class="form-control bg-dark text-light border-secondary"
                   placeholder="ej. Servidor Web Producción" required>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Identificador <span class="text-danger">*</span></label>
            <input type="text" name="identifier" class="form-control bg-dark text-light border-secondary font-monospace"
                   placeholder="IP, CIDR, hostname, username..." required>
          </div>
          <div class="col-md-4">
            <label class="form-label small">Tipo de Activo</label>
            <select name="asset_type" class="form-select bg-dark text-light border-secondary">
              {% for val, label in asset_types %}
              <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small">Criticidad</label>
            <select name="criticality" class="form-select bg-dark text-light border-secondary" id="selCrit">
              {% for lvl in range(5, 0, -1) %}
              {% set cl = criticality_labels[lvl] %}
              <option value="{{ lvl }}" {{ 'selected' if lvl == 3 }}>{{ lvl }} — {{ cl[0] }}</option>
              {% endfor %}
            </select>
            <div class="form-text" id="critHint">
              <span id="multBadge" class="badge bg-info text-dark">×1.1 (leve incremento)</span>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label small">Ciclo de Revisión</label>
            <select name="review_cycle" class="form-select bg-dark text-light border-secondary">
              <option value="3">Cada 3 meses</option>
              <option value="6" selected>Cada 6 meses</option>
            </select>
          </div>
          {% if user.role == "super_admin" and orgs %}
          <div class="col-md-6">
            <label class="form-label small">Organización</label>
            <select name="organization_id" class="form-select bg-dark text-light border-secondary">
              {% for o in orgs %}
              <option value="{{ o.id }}">{{ o.name }}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
          <div class="col-12">
            <label class="form-label small">Descripción</label>
            <textarea name="description" class="form-control bg-dark text-light border-secondary" rows="2"
                      placeholder="Descripción del activo, función, notas relevantes..."></textarea>
          </div>
          <div class="col-12">
            <label class="form-label small">Tags <span class="text-muted">(separados por coma)</span></label>
            <input type="text" name="tags" class="form-control bg-dark text-light border-secondary"
                   placeholder="produccion, critico, web, basededatos">
          </div>
          <!-- Contacto responsable -->
          <div class="col-12 mt-2">
            <h6 class="text-muted border-bottom border-secondary pb-1 mb-3">
              <i class="bi bi-person-lines-fill me-1"></i>Contacto Responsable
            </h6>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Nombre del Responsable</label>
            <input type="text" name="contact_name" class="form-control bg-dark text-light border-secondary"
                   placeholder="Nombre completo">
          </div>
          <div class="col-md-6">
            <label class="form-label small">Tipo de Contacto</label>
            <select name="contact_type" class="form-select bg-dark text-light border-secondary">
              {% for val, label in contact_types %}
              <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small">Email</label>
            <input type="email" name="contact_email" class="form-control bg-dark text-light border-secondary"
                   placeholder="usuario@empresa.com">
          </div>
          <div class="col-md-4">
            <label class="form-label small">Teléfono Personal</label>
            <input type="text" name="contact_phone_personal" class="form-control bg-dark text-light border-secondary"
                   placeholder="+54 9 11 1234-5678">
          </div>
          <div class="col-md-4">
            <label class="form-label small">Teléfono Corporativo</label>
            <input type="text" name="contact_phone_corporate" class="form-control bg-dark text-light border-secondary"
                   placeholder="+54 11 5555-0000 int 123">
          </div>
          <!-- Ubicación -->
          <div class="col-12 mt-2">
            <h6 class="text-muted border-bottom border-secondary pb-1 mb-3">
              <i class="bi bi-geo-alt-fill me-1"></i>Ubicación
            </h6>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Etiqueta de Ubicación</label>
            <input type="text" name="location_label" class="form-control bg-dark text-light border-secondary"
                   placeholder="ej. Sede Central — Rack 3, U12">
          </div>
          <div class="col-md-6">
            <label class="form-label small">Dirección Física</label>
            <input type="text" name="location_address" class="form-control bg-dark text-light border-secondary"
                   placeholder="Av. Corrientes 1234, CABA">
          </div>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-warning">
          <i class="bi bi-save me-1"></i>Guardar Activo
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Importar CSV -->
<div class="modal fade" id="modalImport" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="/activos/importar" enctype="multipart/form-data"
          class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="bi bi-upload text-warning me-2"></i>Importar desde CSV</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Usá el <a href="/activos/exportar/template" class="alert-link">Template CSV</a>
          como modelo. Los campos mínimos requeridos son <strong>name</strong> e <strong>identifier</strong>.
        </div>
        {% if user.role == "super_admin" and orgs %}
        <div class="mb-3">
          <label class="form-label small">Organización destino</label>
          <select name="organization_id" class="form-select bg-dark text-light border-secondary">
            {% for o in orgs %}
            <option value="{{ o.id }}">{{ o.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        <div class="mb-3">
          <label class="form-label small">Archivo CSV <span class="text-danger">*</span></label>
          <input type="file" name="file" class="form-control bg-dark text-light border-secondary"
                 accept=".csv" required>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-warning">
          <i class="bi bi-upload me-1"></i>Importar
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Update multiplier hint when criticality changes
const multMap = {5: '×1.5 (activo CRÍTICO — fuerte incremento de urgencia)',
                  4: '×1.3 (activo ALTO — incremento significativo)',
                  3: '×1.1 (activo MEDIO — leve incremento)',
                  2: '×0.9 (activo BAJO — leve reducción de urgencia)',
                  1: '×0.8 (activo MÍNIMO — puede tratarse como rutina)'};
const colorMap = {5: 'danger', 4: 'warning', 3: 'info', 2: 'secondary', 1: 'dark'};
document.getElementById('selCrit')?.addEventListener('change', function() {
  const v = parseInt(this.value);
  const badge = document.getElementById('multBadge');
  badge.textContent = multMap[v] || '';
  badge.className = 'badge bg-' + (colorMap[v] || 'secondary') + (v <= 2 ? ' text-white' : v == 4 ? ' text-dark' : '');
});
</script>
{% endblock %}
