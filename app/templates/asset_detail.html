{% extends "base.html" %}
{% block title %}Activo: {{ asset.name }}{% endblock %}

{% block content %}
{% set cl = criticality_labels.get(asset.criticality, ('Medio','info')) %}
{% set mult = criticality_multiplier %}

<!-- Header -->
<div class="d-flex justify-content-between align-items-start mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="/activos" class="text-info">Activos</a></li>
        <li class="breadcrumb-item active text-light">{{ asset.name }}</li>
      </ol>
    </nav>
    <h2 class="mb-0">
      <span class="badge bg-{{ cl[1] }} {{ 'text-dark' if cl[1] in ('warning','light','info') else '' }} me-2">
        {{ cl[0] }}
      </span>
      {{ asset.name }}
      {% if not asset.is_active %}
      <span class="badge bg-secondary ms-2">Inactivo</span>
      {% endif %}
    </h2>
    <span class="text-muted">{{ dict(asset_types).get(asset.asset_type, asset.asset_type) }}
      — <code class="text-warning">{{ asset.identifier }}</code></span>
  </div>
  <div class="d-flex gap-2">
    <span class="badge bg-{{ 'danger' if mult > 1 else 'success' if mult < 1 else 'secondary' }} fs-6 align-self-center px-3 py-2">
      Multiplicador: ×{{ "%.1f"|format(mult) }}
    </span>
    <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modalEdit">
      <i class="bi bi-pencil me-1"></i>Editar
    </button>
    {% if user.role in ('admin','super_admin') %}
    <form method="post" action="/activos/{{ asset.id }}/toggle-active" class="d-inline">
      <button type="submit" class="btn btn-outline-{{ 'warning' if asset.is_active else 'success' }}">
        <i class="bi bi-{{ 'pause-circle' if asset.is_active else 'play-circle' }} me-1"></i>
        {{ 'Desactivar' if asset.is_active else 'Activar' }}
      </button>
    </form>
    {% endif %}
  </div>
</div>

<!-- Flash -->
{% if msg %}
<div class="alert alert-{{ 'success' if msg in ('created','updated','reviewed','contact_added','location_added') else 'info' }} alert-dismissible fade show mb-3">
  {% if msg == 'created' %}Activo creado correctamente.
  {% elif msg == 'updated' %}Activo actualizado.
  {% elif msg == 'reviewed' %}Revisión registrada. Próxima revisión actualizada.
  {% elif msg == 'contact_added' %}Contacto agregado.
  {% elif msg == 'contact_deleted' %}Contacto eliminado.
  {% elif msg == 'location_added' %}Ubicación agregada.
  {% elif msg == 'location_deleted' %}Ubicación eliminada.
  {% elif msg == 'toggled' %}Estado del activo cambiado.
  {% else %}Operación completada.{% endif %}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row g-4">

  <!-- LEFT: Main info -->
  <div class="col-lg-7">

    <!-- Info card -->
    <div class="card border-secondary mb-4">
      <div class="card-header border-secondary d-flex justify-content-between align-items-center">
        <span><i class="bi bi-info-circle me-2"></i>Información del Activo</span>
        <span class="text-muted small">ID #{{ asset.id }}</span>
      </div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-4 text-muted small">Nombre</dt>
          <dd class="col-sm-8">{{ asset.name }}</dd>
          <dt class="col-sm-4 text-muted small">Tipo</dt>
          <dd class="col-sm-8">{{ dict(asset_types).get(asset.asset_type, asset.asset_type) }}</dd>
          <dt class="col-sm-4 text-muted small">Identificador</dt>
          <dd class="col-sm-8"><code class="text-warning">{{ asset.identifier }}</code></dd>
          <dt class="col-sm-4 text-muted small">Criticidad</dt>
          <dd class="col-sm-8">
            <span class="badge bg-{{ cl[1] }} {{ 'text-dark' if cl[1] in ('warning','light','info') else '' }}">
              {{ asset.criticality }} — {{ cl[0] }}
            </span>
          </dd>
          <dt class="col-sm-4 text-muted small">Multiplicador</dt>
          <dd class="col-sm-8">
            <span class="badge bg-{{ 'danger' if mult > 1 else 'success' if mult < 1 else 'secondary' }}">
              ×{{ "%.1f"|format(mult) }}
            </span>
            <small class="text-muted ms-2">
              {% if mult > 1 %}Incrementa urgencia de incidentes
              {% elif mult < 1 %}Reduce urgencia (activo rutinario)
              {% else %}Sin modificación de score{% endif %}
            </small>
          </dd>
          {% if asset.description %}
          <dt class="col-sm-4 text-muted small">Descripción</dt>
          <dd class="col-sm-8">{{ asset.description }}</dd>
          {% endif %}
          {% if tags_list %}
          <dt class="col-sm-4 text-muted small">Tags</dt>
          <dd class="col-sm-8">
            {% for tag in tags_list %}
            <span class="badge bg-secondary me-1">{{ tag }}</span>
            {% endfor %}
          </dd>
          {% endif %}
          <dt class="col-sm-4 text-muted small">Ciclo de Revisión</dt>
          <dd class="col-sm-8">Cada {{ asset.review_cycle }} meses</dd>
          <dt class="col-sm-4 text-muted small">Última Revisión</dt>
          <dd class="col-sm-8">
            {{ asset.last_reviewed_at.strftime('%Y-%m-%d') if asset.last_reviewed_at else '—' }}
          </dd>
          <dt class="col-sm-4 text-muted small">Próxima Revisión</dt>
          <dd class="col-sm-8">
            {% if asset.next_review_at %}
            {% set is_overdue = asset.next_review_at < now if now is defined else false %}
            <span class="{{ 'text-danger fw-bold' if is_overdue else '' }}">
              <i class="bi bi-{{ 'exclamation-triangle-fill text-danger' if is_overdue else 'calendar-check' }} me-1"></i>
              {{ asset.next_review_at.strftime('%Y-%m-%d') }}
              {% if is_overdue %}<span class="badge bg-danger ms-1">VENCIDA</span>{% endif %}
            </span>
            {% else %}—{% endif %}
          </dd>
          <dt class="col-sm-4 text-muted small">Alta en sistema</dt>
          <dd class="col-sm-8 text-muted small">{{ asset.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
        </dl>
      </div>
      <div class="card-footer border-secondary bg-transparent">
        <form method="post" action="/activos/{{ asset.id }}/revisar">
          <button type="submit" class="btn btn-sm btn-outline-success">
            <i class="bi bi-check-circle me-1"></i>Marcar como Revisado
          </button>
        </form>
      </div>
    </div>

    <!-- Incidents linked -->
    <div class="card border-secondary">
      <div class="card-header border-secondary">
        <i class="bi bi-shield-exclamation me-2"></i>Incidentes Vinculados
        <span class="badge bg-secondary ms-1">{{ linked_incidents | length }}</span>
      </div>
      {% if linked_incidents %}
      <div class="table-responsive">
        <table class="table table-dark table-hover table-sm mb-0">
          <thead class="text-muted small border-secondary">
            <tr>
              <th>#</th><th>Fecha</th><th>Clasificación</th><th>Score</th><th>Analista</th>
            </tr>
          </thead>
          <tbody>
            {% for inc in linked_incidents %}
            {% set th = thresholds.get(inc.classification, {}) %}
            <tr>
              <td><a href="/incidentes/{{ inc.id }}" class="text-info">#{{ inc.id }}</a></td>
              <td class="text-muted small">{{ inc.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>
                <span class="badge" style="background:{{ {'informativo':'#198754','sospechoso':'#ffc107','incidente':'#fd7e14','critico':'#dc3545','brecha':'#6f1a1a'}.get(inc.classification,'#6c757d') }}">
                  {{ th.get('label', inc.classification) }}
                </span>
              </td>
              <td class="fw-bold">{{ inc.final_score | int }}</td>
              <td class="text-muted small">{{ inc.analyst_name or '—' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="card-body text-muted text-center py-4">
        <i class="bi bi-shield-check fs-3 d-block mb-2"></i>
        Sin incidentes vinculados a este activo.
      </div>
      {% endif %}
    </div>

  </div>

  <!-- RIGHT: Contacts + Locations -->
  <div class="col-lg-5">

    <!-- Contacts -->
    <div class="card border-secondary mb-4">
      <div class="card-header border-secondary d-flex justify-content-between align-items-center">
        <span><i class="bi bi-person-lines-fill me-2"></i>Contactos Responsables</span>
        <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#modalAddContact">
          <i class="bi bi-plus"></i>
        </button>
      </div>
      {% if asset.contacts %}
      <div class="list-group list-group-flush">
        {% for c in asset.contacts %}
        <div class="list-group-item bg-transparent border-secondary">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">{{ c.name }}</div>
              <span class="badge bg-secondary me-1" style="font-size:0.65rem;">
                {{ dict(contact_types).get(c.contact_type, c.contact_type) }}
              </span>
              {% if c.email %}
              <div class="small mt-1"><i class="bi bi-envelope me-1 text-muted"></i>
                <a href="mailto:{{ c.email }}" class="text-info">{{ c.email }}</a>
              </div>
              {% endif %}
              {% if c.phone_personal %}
              <div class="small text-muted"><i class="bi bi-phone me-1"></i>Personal: {{ c.phone_personal }}</div>
              {% endif %}
              {% if c.phone_corporate %}
              <div class="small text-muted"><i class="bi bi-telephone me-1"></i>Corp: {{ c.phone_corporate }}</div>
              {% endif %}
              {% if c.notes %}
              <div class="small text-muted fst-italic mt-1">{{ c.notes }}</div>
              {% endif %}
            </div>
            {% if user.role in ('admin','super_admin') %}
            <form method="post" action="/activos/{{ asset.id }}/contacto/{{ c.id }}/eliminar">
              <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-1"
                      onclick="return confirm('¿Eliminar contacto?')">
                <i class="bi bi-trash3" style="font-size:0.75rem;"></i>
              </button>
            </form>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="card-body text-muted text-center py-3">
        <i class="bi bi-person-x d-block mb-1"></i>Sin contactos definidos.
      </div>
      {% endif %}
    </div>

    <!-- Locations -->
    <div class="card border-secondary">
      <div class="card-header border-secondary d-flex justify-content-between align-items-center">
        <span><i class="bi bi-geo-alt-fill me-2"></i>Ubicaciones</span>
        <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#modalAddLocation">
          <i class="bi bi-plus"></i>
        </button>
      </div>
      {% if asset.locations %}
      <div class="list-group list-group-flush">
        {% for loc in asset.locations %}
        <div class="list-group-item bg-transparent border-secondary">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold small"><i class="bi bi-pin-map me-1 text-info"></i>{{ loc.label }}</div>
              {% if loc.address %}
              <div class="text-muted" style="font-size:0.8rem;">{{ loc.address }}</div>
              {% endif %}
            </div>
            {% if user.role in ('admin','super_admin') %}
            <form method="post" action="/activos/{{ asset.id }}/ubicacion/{{ loc.id }}/eliminar">
              <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-1"
                      onclick="return confirm('¿Eliminar ubicación?')">
                <i class="bi bi-trash3" style="font-size:0.75rem;"></i>
              </button>
            </form>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="card-body text-muted text-center py-3">
        <i class="bi bi-geo-alt d-block mb-1"></i>Sin ubicaciones definidas.
      </div>
      {% endif %}
    </div>

  </div>
</div>

<!-- Modal: Editar Activo -->
<div class="modal fade" id="modalEdit" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form method="post" action="/activos/{{ asset.id }}/editar" class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">Editar Activo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label small">Nombre</label>
            <input type="text" name="name" class="form-control bg-dark text-light border-secondary"
                   value="{{ asset.name }}" required>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Identificador</label>
            <input type="text" name="identifier" class="form-control bg-dark text-light border-secondary font-monospace"
                   value="{{ asset.identifier }}" required>
          </div>
          <div class="col-md-4">
            <label class="form-label small">Tipo</label>
            <select name="asset_type" class="form-select bg-dark text-light border-secondary">
              {% for val, label in asset_types.items() %}
              <option value="{{ val }}" {{ 'selected' if asset.asset_type == val }}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small">Criticidad</label>
            <select name="criticality" class="form-select bg-dark text-light border-secondary">
              {% for lvl in range(5, 0, -1) %}
              {% set lbl = criticality_labels[lvl] %}
              <option value="{{ lvl }}" {{ 'selected' if asset.criticality == lvl }}>{{ lvl }} — {{ lbl[0] }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small">Ciclo de Revisión</label>
            <select name="review_cycle" class="form-select bg-dark text-light border-secondary">
              <option value="3" {{ 'selected' if asset.review_cycle == 3 }}>Cada 3 meses</option>
              <option value="6" {{ 'selected' if asset.review_cycle == 6 }}>Cada 6 meses</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label small">Descripción</label>
            <textarea name="description" class="form-control bg-dark text-light border-secondary"
                      rows="2">{{ asset.description or '' }}</textarea>
          </div>
          <div class="col-12">
            <label class="form-label small">Tags</label>
            <input type="text" name="tags" class="form-control bg-dark text-light border-secondary"
                   value="{{ tags_list | join(', ') }}">
          </div>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-warning">Guardar Cambios</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Add Contact -->
<div class="modal fade" id="modalAddContact" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="/activos/{{ asset.id }}/contacto/agregar" class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Agregar Contacto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label small">Nombre <span class="text-danger">*</span></label>
          <input type="text" name="name" class="form-control bg-dark text-light border-secondary" required>
        </div>
        <div class="mb-3">
          <label class="form-label small">Tipo de Contacto</label>
          <select name="contact_type" class="form-select bg-dark text-light border-secondary">
            {% for val, label in contact_types.items() %}
            <option value="{{ val }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label small">Email</label>
          <input type="email" name="email" class="form-control bg-dark text-light border-secondary">
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small">Tel. Personal</label>
            <input type="text" name="phone_personal" class="form-control bg-dark text-light border-secondary">
          </div>
          <div class="col-6">
            <label class="form-label small">Tel. Corporativo</label>
            <input type="text" name="phone_corporate" class="form-control bg-dark text-light border-secondary">
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label small">Notas</label>
          <textarea name="notes" class="form-control bg-dark text-light border-secondary" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-info">Agregar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Add Location -->
<div class="modal fade" id="modalAddLocation" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="/activos/{{ asset.id }}/ubicacion/agregar" class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="bi bi-geo-alt-fill me-2"></i>Agregar Ubicación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label small">Etiqueta <span class="text-danger">*</span></label>
          <input type="text" name="label" class="form-control bg-dark text-light border-secondary"
                 placeholder="ej. Sede Central — Rack 3, U12" required>
        </div>
        <div class="mb-3">
          <label class="form-label small">Dirección Física</label>
          <textarea name="address" class="form-control bg-dark text-light border-secondary" rows="2"
                    placeholder="Av. Corrientes 1234, CABA"></textarea>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-info">Agregar</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
